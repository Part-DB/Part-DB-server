FROM dunglas/frankenphp:1-php8.4 AS frankenphp_upstream

RUN apt-get update && apt-get -y install \
      curl \
      ca-certificates \
      mariadb-client \
      postgresql-client \
      file \
      acl \
      git \
      gettext \
      gnupg \
      zip \
    && apt-get -y autoremove && apt-get clean autoclean && rm -rf /var/lib/apt/lists/*;

RUN set -eux; \
    # Prepare keyrings directory
    mkdir -p /etc/apt/keyrings; \
    \
    # Import Yarn GPG key
    curl -fsSL https://dl.yarnpkg.com/debian/pubkey.gpg \
      | tee /etc/apt/keyrings/yarn.gpg >/dev/null; \
    chmod 644 /etc/apt/keyrings/yarn.gpg; \
    \
    # Add Yarn repo with signed-by
    echo "deb [signed-by=/etc/apt/keyrings/yarn.gpg] https://dl.yarnpkg.com/debian stable main" \
      | tee /etc/apt/sources.list.d/yarn.list; \
    \
    # Run NodeSource setup script (unchanged)
    curl -sL https://deb.nodesource.com/setup_22.x | bash -; \
    \
    # Install Node.js + Yarn
    apt-get update; \
    apt-get install -y --no-install-recommends \
      nodejs \
      yarn; \
    \
    # Cleanup
    apt-get -y autoremove; \
    apt-get clean autoclean; \
    rm -rf /var/lib/apt/lists/*


# Install PHP
RUN set -eux; \
	install-php-extensions \
		@composer \
		apcu \
		intl \
		opcache \
		zip \
        pdo_mysql \
        pdo_sqlite \
        pdo_pgsql \
        gd \
        bcmath \
        xsl \
	;

# Copy config files for php and caddy
COPY --link .docker/frankenphp/conf.d/app.ini $PHP_INI_DIR/conf.d/
COPY --chmod=755 .docker/frankenphp/docker-entrypoint.sh /usr/local/bin/docker-entrypoint
COPY --link .docker/frankenphp/Caddyfile /etc/caddy/Caddyfile
COPY --link .docker/frankenphp/conf.d/app.prod.ini $PHP_INI_DIR/conf.d/
COPY --link .docker/frankenphp/worker.Caddyfile /etc/caddy/worker.Caddyfile
ENV FRANKENPHP_CONFIG="import worker.Caddyfile"

RUN mv "$PHP_INI_DIR/php.ini-production" "$PHP_INI_DIR/php.ini"

# Install composer
ENV COMPOSER_ALLOW_SUPERUSER=1
#COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Create workdir and set permissions if directory does not exists
WORKDIR /app

# prevent the reinstallation of vendors at every changes in the source code
COPY --link composer.* symfony.* ./
RUN set -eux; \
	composer install --no-cache --prefer-dist --no-dev --no-autoloader --no-scripts --no-progress

# copy sources
COPY --link . ./

# Install composer and yarn dependencies for Part-DB
RUN set -eux; \
	mkdir -p var/cache var/log; \
	composer dump-autoload --classmap-authoritative --no-dev; \
	composer dump-env prod; \
	composer run-script --no-dev post-install-cmd; \
	chmod +x bin/console; sync;

RUN yarn install --network-timeout 600000 && \
    yarn build && \
    yarn cache clean && \
    rm -rf node_modules/

# Use docker env to output logs to stdout
ENV APP_ENV=docker
ENV DATABASE_URL="sqlite:///%kernel.project_dir%/uploads/app.db"

USER root

ENTRYPOINT ["docker-entrypoint"]
CMD ["frankenphp", "run", "--config", "/etc/caddy/Caddyfile"]

# https://httpd.apache.org/docs/2.4/stopping.html#gracefulstop
STOPSIGNAL SIGWINCH

VOLUME ["/var/www/html/uploads", "/var/www/html/public/media"]

HEALTHCHECK --start-period=60s CMD curl -f http://localhost:2019/metrics || exit 1

# See https://caddyserver.com/docs/conventions#file-locations for details
ENV XDG_CONFIG_HOME /config
ENV XDG_DATA_HOME /data

EXPOSE 80
EXPOSE 443
EXPOSE 443/udp
EXPOSE 2019
